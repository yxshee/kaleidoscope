<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aesthetic Interactive p5.js Kaleidoscope</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f6; 
            --text-color: #333; 
            --primary-accent: #007bff; 
            --secondary-accent: #6c757d; 
            --border-color: #d1d1d1; 
            --input-bg: #fff; 
            --card-bg: #fff; 
            --shadow-color: rgba(0,0,0,0.08); 
            --title-font: 'Playfair Display', serif; 
            --body-font: 'Roboto', sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
            font-family: var(--body-font);
            color: var(--text-color);
            padding: 20px 10px; 
            box-sizing: border-box;
        }

        .main-title {
            font-family: var(--title-font);
            font-size: clamp(2.5em, 5vw, 3.8em); 
            color: #2c3e50; 
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 1px; 
        }

        .info-text {
            font-size: clamp(0.9em, 2vw, 1em); 
            color: var(--secondary-accent);
            text-align: center;
            margin-bottom: 25px;
            max-width: 600px; 
        }

        #canvas-container {
            margin-bottom: 15px; /* Reduced margin to bring actions bar closer */
            box-shadow: 0 8px 25px var(--shadow-color); 
            border-radius: 12px; 
            overflow: hidden; 
            background-color: #fff; 
        }

        canvas {
            display: block; 
            border-radius: 10px; 
        }

        .canvas-actions-bar {
            display: flex;
            justify-content: center;
            gap: 15px; /* Space between buttons */
            margin-bottom: 25px; /* Space before the main controls grid */
            width: 100%;
            max-width: 600px; /* Align with canvas width or info text */
        }
        .canvas-actions-bar .control-button {
            flex-grow: 1; /* Allow buttons to grow if space allows */
            max-width: 200px; /* Max width for each button */
        }


        .controls-grid {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px; 
            justify-content: center; 
            max-width: 900px; 
            width: 100%;
        }

        fieldset {
            border: 1px solid var(--border-color);
            border-radius: 12px; 
            padding: 20px 25px; 
            background-color: var(--card-bg);
            box-shadow: 0 5px 15px var(--shadow-color); 
            flex: 1 1 280px; 
            min-width: 260px;
            transition: box-shadow 0.3s ease; 
        }
        fieldset:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.12); 
        }

        fieldset legend {
            font-family: var(--body-font);
            font-weight: 500; 
            color: var(--primary-accent);
            padding: 0 10px;
            font-size: 1.2em; 
            margin-left: 5px; 
        }

        fieldset div {
            margin-bottom: 18px; 
            display: flex;
            flex-direction: column; 
            gap: 8px; 
        }

        fieldset div.inline-control { 
            flex-direction: row;
            align-items: center;
            /* justify-content: space-between;  Removed for better checkbox alignment */
        }
         fieldset div.inline-control label { /* Label for checkbox */
            margin-right: auto; /* Pushes checkbox to the right if needed, or just use gap */
            order: 1; /* Label first */
        }
        fieldset div.inline-control input[type="checkbox"] {
            order: 2; /* Checkbox second */
            margin-left: 10px; /* Space between label and checkbox */
        }


        fieldset label {
            font-size: 0.95em;
            color: #555; 
            font-weight: 400; 
        }

        input[type="range"] {
            -webkit-appearance: none; 
            appearance: none; 
            width: 100%;
            height: 8px; 
            background: #ddd; 
            border-radius: 5px; 
            outline: none; 
            padding: 0; 
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; 
            height: 18px; 
            background: var(--primary-accent); 
            border-radius: 50%; 
            cursor: pointer;
            border: 2px solid var(--input-bg); 
        }

        input[type="range"]::-moz-range-thumb { 
            width: 16px;
            height: 16px;
            background: var(--primary-accent);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--input-bg);
        }
        
        select, .toggle-switch button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            box-sizing: border-box;
            font-size: 0.95em;
            font-family: var(--body-font);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="range"]:focus, select:focus, .toggle-switch button:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); 
            outline: none;
        }

        input[type="checkbox"] {
            width: 1.3em; 
            height: 1.3em;
            /* margin-right: 8px; Removed, using gap in inline-control */
            accent-color: var(--primary-accent); 
            cursor: pointer;
            vertical-align: middle; 
        }

        button.control-button { 
            color: white;
            background-color: var(--primary-accent);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: none;
            font-size: 1em;
            font-weight: 500;
            padding: 12px 15px;
            border-radius: 6px; 
        }
        button.control-button:hover {
            background-color: #0056b3; 
            transform: translateY(-1px); 
        }
        button.control-button:active {
            transform: translateY(0px); 
        }

        #saveImageButton { background-color: #28a745; }
        #saveImageButton:hover { background-color: #1e7e34; }

        .slider-value { 
            font-weight: 500;
            color: var(--primary-accent);
            margin-left: 8px;
            font-size: 0.9em;
        }
        
        .toggle-switch {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden; 
        }
        .toggle-switch button {
            flex: 1; 
            padding: 10px;
            border: none;
            background-color: var(--input-bg);
            color: var(--secondary-accent);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            border-radius: 0; 
        }
        .toggle-switch button.active { 
            background-color: var(--primary-accent);
            color: white;
            font-weight: 500;
        }
        .toggle-switch button:first-child { 
            border-right: 1px solid var(--border-color); 
        }

        /* Class to visually de-emphasize disabled controls */
        .control-disabled {
            opacity: 0.5;
            pointer-events: none; /* Optional: also disable clicks on the div */
        }
        .control-disabled input[type="range"]::-webkit-slider-thumb {
            background: var(--secondary-accent); /* Grey out thumb */
        }
        .control-disabled input[type="range"]::-moz-range-thumb {
            background: var(--secondary-accent); /* Grey out thumb for Firefox */
        }


    </style>
</head>
<body>
    <h1 class="main-title">Kaleidoscope Dreams</h1>
    <p class="info-text">Craft mesmerizing symmetrical art. Click and drag on the canvas, and explore the controls to shape your vision.</p>
    
    <div id="canvas-container"></div>
    
    <div class="canvas-actions-bar">
        <button id="clearButton" class="control-button">Clear Canvas</button>
        <button id="saveImageButton" class="control-button">Save Image</button>
    </div>

    <div class="controls-grid">
        <fieldset>
            <legend>Artistry</legend>
            <div>
                <label for="drawingModeSelect">Drawing Mode:</label>
                <select id="drawingModeSelect">
                    <option value="line">Flowing Lines</option>
                    <option value="circle">Mystic Circles</option>
                    <option value="triangle">Crystal Triangles</option>
                    <option value="star">Celestial Stars</option>
                    <option value="randomShape">Chaotic Polygons</option>
                </select>
            </div>
            <div>
                <label for="brushSizeSlider">Brush Size: <span id="brushSizeValue" class="slider-value">10</span></label>
                <input type="range" id="brushSizeSlider" min="1" max="50" value="10">
            </div>
             <div class="inline-control">
                <label for="shapeSpinCheckbox">Shape Spin:</label>
                <input type="checkbox" id="shapeSpinCheckbox">
            </div>
        </fieldset>

        <fieldset>
            <legend>Color Realm</legend>
            <div>
                <label for="colorPaletteSelect">Color Palette:</label>
                <select id="colorPaletteSelect">
                    <option value="rainbow">Rainbow Cycle</option>
                    <option value="ocean">Ocean Blues</option>
                    <option value="sunset">Sunset Hues</option>
                    <option value="forest">Forest Greens</option>
                    <option value="monochrome">Monochrome Grays</option>
                </select>
            </div>
            <div>
                <label for="saturationSlider">Saturation: <span id="saturationValue" class="slider-value">90</span></label>
                <input type="range" id="saturationSlider" min="0" max="100" value="90">
            </div>
            <div>
                <label for="brightnessSlider">Brightness: <span id="brightnessValue" class="slider-value">90</span></label>
                <input type="range" id="brightnessSlider" min="0" max="100" value="90">
            </div>
            <div>
                <label for="alphaSlider">Shape Opacity: <span id="alphaValue" class="slider-value">70</span></label>
                <input type="range" id="alphaSlider" min="0" max="100" value="70">
            </div>
        </fieldset>

        <fieldset>
            <legend>Canvas & Effects</legend>
            <div>
                <label for="canvasThemeToggle">Canvas Theme:</label>
                <div class="toggle-switch" id="canvasThemeToggle">
                    <button data-theme="light" class="active">Light</button>
                    <button data-theme="dark">Dark</button>
                </div>
            </div>
            <div>
                <label for="symmetrySlider">Symmetry: <span id="symmetryDisplayValue" class="slider-value">6</span></label>
                <input type="range" id="symmetrySlider" min="2" max="30" value="6"> 
            </div>
            <div class="inline-control">
                <label for="trailEffectCheckbox">Trail Effect:</label>
                <input type="checkbox" id="trailEffectCheckbox">
            </div>
            <div id="trailPersistenceControlContainer"> 
                <label for="trailFadeSlider">Trail Persistence: <span id="trailFadeValue" class="slider-value">85</span></label>
                <input type="range" id="trailFadeSlider" min="0" max="98" value="85" disabled>
            </div>
        </fieldset>
    </div>

    <script>
        // --- Global Variables ---
        let symmetry = 6; 
        let angle;       
        let p5Canvas;    

        // Drawing Style Variables
        let drawingMode = 'line';       
        let currentBrushSize = 10;    
        let enableShapeSpin = false;    
        let currentShapeAngle = 0;    

        // Color Variables
        let hueValue = 0;             
        let saturationValue = 90;     
        let brightnessValue = 90;     
        let alphaValue = 70;          
        let selectedColorPalette = 'rainbow'; 

        // Canvas & Effects Variables
        let isDarkTheme = false;      
        let trailEffectActive = false;
        let trailPersistence = 85;    

        const lightThemeBg = [10, 5, 97]; 
        const darkThemeBg = [220, 15, 15]; 

        const palettes = {
            rainbow: { type: 'cycle', hues: [0, 360] }, 
            ocean: { type: 'random', colors: [[180, 70, 80], [190, 80, 70], [200, 90, 90], [210, 60, 60], [220, 75, 75]] },
            sunset: { type: 'random', colors: [[15, 90, 90], [30, 100, 85], [45, 85, 90], [5, 80, 80], [350, 90, 75]] },
            forest: { type: 'random', colors: [[90, 60, 50], [100, 70, 60], [110, 50, 40], [120, 65, 55], [80, 55, 45]] },
            monochrome: { type: 'random', colors: [[0, 0, 20], [0, 0, 40], [0, 0, 60], [0, 0, 70], [0, 0, 80]] }
        };
        let currentPaletteColorIndex = 0; 


        // --- P5.js Setup Function: Runs once when the sketch starts ---
        function setup() {
            p5Canvas = createCanvas(600, 600); 
            p5Canvas.parent('canvas-container'); 

            angleMode(DEGREES); 
            colorMode(HSB, 360, 100, 100, 100); 
            applyCanvasTheme(); 
            updateSymmetry(symmetry); 

            // --- UI Element Setup & Event Handlers ---
            select('#drawingModeSelect').changed(function() { drawingMode = this.value(); });
            
            select('#brushSizeSlider').input(function() {
                currentBrushSize = parseInt(this.value());
                select('#brushSizeValue').html(currentBrushSize);
            });
            select('#brushSizeValue').html(currentBrushSize); 

            select('#shapeSpinCheckbox').changed(function() { enableShapeSpin = this.checked(); });

            select('#colorPaletteSelect').changed(function() { 
                selectedColorPalette = this.value(); 
                currentPaletteColorIndex = 0; 
            });

            select('#saturationSlider').input(function() {
                saturationValue = parseInt(this.value());
                select('#saturationValue').html(saturationValue);
            });
            select('#saturationValue').html(saturationValue);

            select('#brightnessSlider').input(function() {
                brightnessValue = parseInt(this.value());
                select('#brightnessValue').html(brightnessValue);
            });
            select('#brightnessValue').html(brightnessValue);
            
            select('#alphaSlider').input(function() { 
                alphaValue = parseInt(this.value());
                select('#alphaValue').html(alphaValue);
            });
            select('#alphaValue').html(alphaValue);

            const themeToggleButtons = selectAll('#canvasThemeToggle button');
            themeToggleButtons.forEach(button => {
                button.mousePressed(() => {
                    isDarkTheme = button.attribute('data-theme') === 'dark';
                    themeToggleButtons.forEach(btn => btn.removeClass('active')); 
                    button.addClass('active'); 
                    applyCanvasTheme(); 
                });
            });

            select('#symmetrySlider').input(function() {
                updateSymmetry(parseInt(this.value()));
            });
            select('#symmetryDisplayValue').html(symmetry);

            const trailFadeSlider = select('#trailFadeSlider');
            const trailPersistenceControlContainer = select('#trailPersistenceControlContainer'); // Get the div

            trailFadeSlider.input(function() {
                trailPersistence = parseInt(this.value());
                select('#trailFadeValue').html(trailPersistence);
            });
            select('#trailFadeValue').html(trailPersistence); 

            select('#trailEffectCheckbox').changed(function() {
                trailEffectActive = this.checked();
                if (trailEffectActive) {
                    trailFadeSlider.removeAttribute('disabled'); 
                    trailPersistenceControlContainer.removeClass('control-disabled'); // Visually enable
                } else {
                    trailFadeSlider.attribute('disabled', ''); 
                    trailPersistenceControlContainer.addClass('control-disabled'); // Visually disable
                    applyCanvasTheme(); 
                }
            });
             // Initial check for trail persistence control visibility
            if (!trailEffectActive) {
                trailPersistenceControlContainer.addClass('control-disabled');
            }


            select('#clearButton').mousePressed(applyCanvasTheme); 
            select('#saveImageButton').mousePressed(saveKaleidoscopeImage);
        }
        
        function applyCanvasTheme() {
            let bg = isDarkTheme ? darkThemeBg : lightThemeBg; 
            background(bg[0], bg[1], bg[2]); 
        }

        function updateSymmetry(newSymmetry) {
            symmetry = newSymmetry;
            angle = 360 / symmetry; 
            select('#symmetryDisplayValue').html(symmetry); 
            applyCanvasTheme(); 
        }

        function saveKaleidoscopeImage() {
            saveCanvas(p5Canvas, 'kaleidoscope_dream', 'png'); 
        }
        
        function drawStar(x, y, radius1, radius2, npoints) {
            let angleOffset = 360 / npoints; 
            let halfAngleOffset = angleOffset / 2.0; 
            beginShape(); 
            for (let a = 0; a < 360; a += angleOffset) { 
                vertex(x + cos(a) * radius2, y + sin(a) * radius2);
                vertex(x + cos(a + halfAngleOffset) * radius1, y + sin(a + halfAngleOffset) * radius1);
            }
            endShape(CLOSE); 
        }
        
        function getCurrentDrawingColor() {
            let h, s, b; 
            const palette = palettes[selectedColorPalette]; 

            if (palette.type === 'cycle') { 
                hueValue = (hueValue + 0.7) % 360; 
                h = hueValue;
                s = saturationValue; 
                b = brightnessValue; 
            } else { 
                let colors = palette.colors;
                if (frameCount % 10 === 0) { 
                     currentPaletteColorIndex = (currentPaletteColorIndex + 1) % colors.length;
                }
                let selected = colors[currentPaletteColorIndex]; 
                h = selected[0]; 
                s = selected[1]; 
                b = selected[2]; 
            }
            return [h, s, b, alphaValue]; 
        }

        function draw() {
            if (trailEffectActive) {
                let bg = isDarkTheme ? darkThemeBg : lightThemeBg;
                let trailAlphaForBg = map(trailPersistence, 0, 98, 95, 2); 
                background(bg[0], bg[1], bg[2], trailAlphaForBg);
            } else if (frameCount === 1 && !trailEffectActive) { 
                applyCanvasTheme();
            }

            translate(width / 2, height / 2);

            if (enableShapeSpin) {
                currentShapeAngle = (currentShapeAngle + 0.5) % 360; 
            }

            if (mouseIsPressed && mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height) {
                let mx = mouseX - width / 2;
                let my = mouseY - height / 2;
                let pmx = pmouseX - width / 2; 
                let pmy = pmouseY - height / 2; 

                let [h, s, b, a] = getCurrentDrawingColor(); 
                
                stroke(h, s, b, a); 
                fill(h, s, b, a * 0.85); 
                
                drawSymmetricalShapes(mx, my, pmx, pmy);
            }
        }

        function drawSymmetricalShapes(mx, my, pmx, pmy) {
            for (let i = 0; i < symmetry; i++) { 
                rotate(angle); 
                
                push(); 
                if (enableShapeSpin && drawingMode !== 'line') {
                    translate(mx, my); 
                    rotate(currentShapeAngle); 
                    drawCurrentShape(0, 0, pmx - mx, pmy - my); 
                } else {
                    drawCurrentShape(mx, my, pmx, pmy); 
                }
                pop(); 
                
                push();
                scale(1, -1); 
                if (enableShapeSpin && drawingMode !== 'line') {
                    translate(mx, my);
                    rotate(currentShapeAngle);
                    drawCurrentShape(0, 0, pmx - mx, pmy - my);
                } else {
                    drawCurrentShape(mx, my, pmx, pmy);
                }
                pop(); 
            }
        }

        function drawCurrentShape(shapeX, shapeY, prevShapeX, prevShapeY) {
            push(); 
            
            let R = currentBrushSize * 1.5; 
            let lineWeight = currentBrushSize; 

            if (drawingMode === 'line') {
                let speed = dist(mouseX, mouseY, pmouseX, pmouseY); 
                lineWeight = map(speed, 0, 30, currentBrushSize * 1.5, currentBrushSize * 0.5, true);
                lineWeight = constrain(lineWeight, 1, currentBrushSize * 2); 
                strokeWeight(lineWeight);
                noFill(); 
            } else {
                strokeWeight(max(1, currentBrushSize / 6)); 
            }

            switch (drawingMode) {
                case 'line':
                    line(shapeX, shapeY, prevShapeX, prevShapeY);
                    break;
                case 'circle':
                    ellipse(shapeX, shapeY, R * 2, R * 2);
                    break;
                case 'triangle':
                    let r = R * 1.2; 
                    triangle(
                        shapeX, shapeY - r, 
                        shapeX - r * cos(30), shapeY + r * sin(30), 
                        shapeX + r * cos(30), shapeY + r * sin(30)  
                    );
                    break;
                case 'star':
                    drawStar(shapeX, shapeY, R * 0.6, R * 1.3, 5); 
                    break;
                case 'randomShape':  
                    beginShape();
                    let numVertices = floor(random(3, 8)); 
                    for (let j = 0; j < numVertices; j++) {
                        let angleR = random(360); 
                        let radiusR = random(R * 0.3, R * 1.2); 
                        vertex(shapeX + cos(angleR) * radiusR, shapeY + sin(angleR) * radiusR);
                    }
                    endShape(CLOSE);
                    break;
            }
            pop(); 
        }

        function touchStarted(event) {
          if (event.target === p5Canvas.elt) { 
            return false; 
          }
        }
        function touchMoved(event) {
          if (event.target === p5Canvas.elt) {
            return false; 
          }
        }
    </script>
</body>
</html>
